<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>HafCaf</title>
<meta name="description" content="See exactly how much caffeine will be in your system at bedtime." />
<link rel="icon" type="image/svg+xml" href="tea.svg" />
<link rel="apple-touch-icon" sizes="180x180" href="tea.svg" />
<style>
:root {
 --bg: #000000;
 --surface: #1C1C1E;
 --surface-hover: #2C2C2E;
 --text: #FFFFFF;
 --text-secondary: #8E8E93;
 --accent: #007AFF;
 --success: #30D158;
 --warning: #FF9500;
 --danger: #FF453A;
 --radius: 20px;
 --shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
 --transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

* { 
 box-sizing: border-box; 
 margin: 0; 
 padding: 0; 
}

body {
 font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
 background: var(--bg);
 color: var(--text);
 line-height: 1.4;
 -webkit-font-smoothing: antialiased;
 -webkit-text-size-adjust: 100%;
 -webkit-touch-callout: none;
 -webkit-user-select: none;
 -moz-user-select: none;
 -ms-user-select: none;
 user-select: none;
 min-height: 100vh;
 display: flex;
 align-items: center;
 justify-content: center;
 padding: 0;
 overflow-x: hidden;
}

.app {
 width: 100%;
 max-width: 420px;
 background: var(--surface);
 border-radius: 0;
 box-shadow: none;
 overflow: hidden;
 backdrop-filter: blur(20px);
 min-height: 100vh;
}

.header {
 text-align: center;
 padding: 40px 24px 24px;
 background: var(--surface);
}

.title {
 font-size: 24px;
 font-weight: 700;
 margin-bottom: 8px;
 letter-spacing: -0.5px;
 color: var(--text);
}

.subtitle {
 color: var(--text-secondary);
 font-size: 15px;
 font-weight: 400;
}

.main {
 padding: 24px;
}

.section-title {
 font-size: 17px;
 font-weight: 600;
 margin-bottom: 16px;
 color: var(--text);
}

.bedtime-selector {
 margin-bottom: 24px;
}

.bedtime-grid {
 display: grid;
 grid-template-columns: repeat(3, 1fr);
 gap: 8px;
}

.bedtime-btn {
 background: rgba(255, 255, 255, 0.05);
 border: 2px solid transparent;
 border-radius: 10px;
 padding: 12px 8px;
 color: var(--text);
 text-align: center;
 cursor: pointer;
 transition: var(--transition);
 font-size: 14px;
 font-weight: 600;
 touch-action: manipulation;
}

.bedtime-btn:hover {
 border-color: var(--accent);
 background: rgba(0, 122, 255, 0.1);
 transform: translateY(-1px);
}

.bedtime-btn.selected {
 border-color: var(--accent);
 background: var(--accent);
 color: white;
}

.drink-selector {
 margin-bottom: 24px;
}

.drinks {
 display: grid;
 grid-template-columns: repeat(2, 1fr);
 gap: 16px;
}

.drink {
 background: rgba(255, 255, 255, 0.05);
 border: 2px solid transparent;
 border-radius: 16px;
 padding: 24px 16px;
 text-align: center;
 cursor: pointer;
 transition: var(--transition);
 position: relative;
 overflow: hidden;
 color: white;
 touch-action: manipulation;
}

.drink:hover {
 border-color: var(--accent);
 background: rgba(0, 122, 255, 0.1);
 transform: translateY(-2px);
}

.drink.selected {
 border-color: var(--accent);
 background: var(--accent);
 color: white;
}


.drink-name {
 font-weight: 600;
 font-size: 17px;
 margin-bottom: 6px;
}

.drink-caffeine {
 font-size: 15px;
 opacity: 0.8;
}

.amount-selector {
 margin-bottom: 24px;
}

.amount-controls {
 display: flex;
 align-items: center;
 justify-content: center;
 background: rgba(255, 255, 255, 0.05);
 border-radius: 16px;
 padding: 20px;
 gap: 32px;
}

.amount-btn {
 width: 48px;
 height: 48px;
 border-radius: 50%;
 background: rgba(255, 255, 255, 0.1);
 border: none;
 color: var(--text);
 font-size: 24px;
 font-weight: 300;
 cursor: pointer;
 transition: var(--transition);
 display: flex;
 align-items: center;
 justify-content: center;
 touch-action: manipulation;
}

.amount-btn:hover {
 background: var(--accent);
 transform: scale(1.1);
}

.amount-btn:disabled {
 opacity: 0.3;
 cursor: not-allowed;
 transform: none;
}

.amount-display {
 font-size: 36px;
 font-weight: 700;
 min-width: 80px;
 text-align: center;
 color: var(--accent);
}

.time-selector {
 /* Removed margin-bottom */
}

.time-options {
 display: flex;
 gap: 12px;
 margin-bottom: 12px;
}

.time-option {
 flex: 1;
 background: rgba(255, 255, 255, 0.05);
 border: 2px solid transparent;
 border-radius: 12px;
 padding: 16px 12px;
 color: var(--text);
 text-align: center;
 cursor: pointer;
 transition: var(--transition);
 font-size: 15px;
 font-weight: 600;
 touch-action: manipulation;
}

.time-option:hover {
 border-color: var(--accent);
 background: rgba(0, 122, 255, 0.1);
}

.time-option.selected {
 border-color: var(--accent);
 background: var(--accent);
 color: white;
}

.time-picker {
 display: none;
 grid-template-columns: repeat(4, 1fr);
 gap: 8px;
 background: rgba(255, 255, 255, 0.05);
 border-radius: 12px;
 padding: 20px;
 margin-bottom: 0;
}

.time-picker.show {
 display: grid;
}

.time-btn {
 background: rgba(255, 255, 255, 0.05);
 border: 1px solid rgba(255, 255, 255, 0.1);
 border-radius: 8px;
 padding: 12px 8px;
 color: var(--text);
 text-align: center;
 cursor: pointer;
 transition: var(--transition);
 font-size: 14px;
 font-weight: 500;
 touch-action: manipulation;
}

.time-btn:hover {
 border-color: var(--accent);
 background: rgba(0, 122, 255, 0.1);
}

.time-btn.selected {
 border-color: var(--accent);
 background: var(--accent);
 color: white;
}


.total-dose {
  text-align: center;
  padding: 24px;
  background: rgba(0, 122, 255, 0.1);
  border-radius: 16px;
  margin-bottom: 24px;
  border: 1px solid rgba(0, 122, 255, 0.2);
  opacity: 0;
  transform: translateY(20px);
  transition: var(--transition);
  display: none;
}

.total-dose.show {
  opacity: 1;
  transform: translateY(0);
  display: block;
}

.dose-amount {
 font-size: 28px;
 font-weight: 700;
 color: var(--accent);
 margin-bottom: 8px;
}

.dose-label {
 color: var(--text-secondary);
 font-size: 16px;
}

.cta-button {
 width: 100%;
 background: var(--success);
 border: none;
 border-radius: 16px;
 padding: 24px;
 color: white;
 font-size: 20px;
 font-weight: 700;
 cursor: pointer;
 transition: var(--transition);
 letter-spacing: -0.5px;
 touch-action: manipulation;
}

.cta-button:hover {
 background: #28B946;
 transform: translateY(-1px);
}

.cta-button:disabled {
 background: rgba(255, 255, 255, 0.1);
 color: var(--text-secondary);
 cursor: not-allowed;
 transform: none;
}

.empty-state {
 text-align: center;
 padding: 60px 40px;
 color: var(--text-secondary);
}

.empty-icon {
 font-size: 48px;
 margin-bottom: 16px;
 opacity: 0.6;
}

.empty-text {
 font-size: 17px;
 font-weight: 500;
}

.results {
 background: rgba(255, 255, 255, 0.02);
 padding: 40px;
 margin-top: 40px;
 border-top: 1px solid rgba(255, 255, 255, 0.1);
 opacity: 0;
 transform: translateY(40px);
 transition: var(--transition);
 display: none;
}

.results.show {
 opacity: 1;
 transform: translateY(0);
 display: block;
}

.bedtime-result {
 text-align: center;
 margin-bottom: 40px;
 padding: 32px;
 background: rgba(255, 255, 255, 0.05);
 border-radius: 20px;
 border: 1px solid rgba(255, 255, 255, 0.1);
}

.bedtime-time {
 font-size: 24px;
 font-weight: 600;
 color: var(--text-secondary);
 margin-bottom: 16px;
}

.caffeine-at-bedtime {
 font-size: 56px;
 font-weight: 800;
 margin-bottom: 12px;
 letter-spacing: -2px;
}

.caffeine-at-bedtime.high {
 color: var(--danger);
}

.caffeine-at-bedtime.medium {
 color: var(--warning);
}

.caffeine-at-bedtime.low {
 color: var(--success);
}

.caffeine-status {
 font-size: 18px;
 font-weight: 500;
 margin-bottom: 16px;
}

.caffeine-note {
 font-size: 15px;
 color: var(--text-secondary);
 line-height: 1.4;
}

.drinks-log {
 margin-bottom: 40px;
}

.drink-entry {
 display: flex;
 align-items: center;
 padding: 16px;
 background: rgba(255, 255, 255, 0.05);
 border-radius: 12px;
 margin-bottom: 12px;
 border: 1px solid rgba(255, 255, 255, 0.1);
 animation: slideIn 0.4s ease-out;
}

.drink-info {
 flex: 1;
}

.drink-entry-name {
 font-weight: 600;
 font-size: 16px;
 margin-bottom: 4px;
}

.drink-entry-details {
 font-size: 14px;
 color: var(--text-secondary);
}

.delete-btn {
 width: 32px;
 height: 32px;
 border-radius: 50%;
 background: rgba(255, 68, 58, 0.2);
 border: 1px solid rgba(255, 68, 58, 0.3);
 color: var(--danger);
 cursor: pointer;
 transition: var(--transition);
 display: flex;
 align-items: center;
 justify-content: center;
 font-size: 18px;
 font-weight: 300;
 touch-action: manipulation;
}

.delete-btn:hover {
 background: var(--danger);
 color: white;
 transform: scale(1.1);
}

.timeline {
 list-style: none;
}

.timeline-item {
 display: flex;
 align-items: center;
 padding: 16px 0;
 border-bottom: 1px solid rgba(255, 255, 255, 0.05);
 animation: slideIn 0.6s ease-out forwards;
 opacity: 0;
 transform: translateX(-20px);
}

.timeline-item:last-child {
 border-bottom: none;
}

.timeline-time {
 font-size: 16px;
 font-weight: 600;
 min-width: 70px;
 color: var(--text-secondary);
}

.timeline-bar {
 flex: 1;
 height: 6px;
 background: rgba(255, 255, 255, 0.1);
 border-radius: 3px;
 margin: 0 16px;
 position: relative;
 overflow: hidden;
}

.timeline-fill {
 height: 100%;
 border-radius: 3px;
 transition: width 1s ease-out;
}

.timeline-amount {
 font-size: 15px;
 color: var(--text);
 min-width: 50px;
 text-align: right;
 font-weight: 600;
}

.fill-high { background: var(--danger); }
.fill-medium { background: var(--warning); }
.fill-low { background: var(--success); }
.fill-clear { background: var(--success); opacity: 0.5; }

.reset-button {
 width: 100%;
 background: rgba(255, 255, 255, 0.1);
 border: 1px solid rgba(255, 255, 255, 0.2);
 border-radius: 16px;
 padding: 20px;
 color: var(--text);
 font-size: 16px;
 font-weight: 600;
 cursor: pointer;
 margin-top: 32px;
 transition: var(--transition);
 touch-action: manipulation;
}

.reset-button:hover {
 background: rgba(255, 255, 255, 0.15);
 border-color: rgba(255, 255, 255, 0.3);
}

@keyframes slideIn {
 to {
   opacity: 1;
   transform: translateX(0);
 }
}

@media (min-width: 481px) {
 body {
   padding: 20px;
   align-items: center;
 }
 
 .app {
   border-radius: var(--radius);
   box-shadow: var(--shadow);
   min-height: auto;
 }
 
 .header {
   padding: 40px 32px 32px;
 }
 
 .title {
   font-size: 28px;
 }
 
 .subtitle {
   font-size: 16px;
 }
 
 .main {
   padding: 32px;
 }
 
 .results {
   padding: 32px;
 }
}

@media (max-width: 480px) {
 .app {
   border-radius: 0;
   max-width: 100vw;
 }
 
 .bedtime-grid {
   grid-template-columns: repeat(3, 1fr);
 }
 
 .time-picker {
   grid-template-columns: repeat(3, 1fr);
 }
 
 .amount-controls {
   gap: 20px;
 }
 
 .amount-display {
   font-size: 24px;
 }
 
 .empty-state {
   padding: 40px 20px;
 }
 
 .empty-icon {
   font-size: 40px;
 }
}
</style>
</head>
<body>
  <div class="app">
    <div class="header">
      <h1 class="title">🧋 HafCaf</h1>
      <p class="subtitle">Track caffeine intake and see bedtime levels based on its average halflife of 5 hours.</p>
    </div>
    
    <div class="main">
      <div class="bedtime-selector">
        <h2 class="section-title">When do you go to bed?</h2>
        <div class="bedtime-grid">
          <button class="bedtime-btn" data-hour="21">9 PM</button>
          <button class="bedtime-btn selected" data-hour="22">10 PM</button>
          <button class="bedtime-btn" data-hour="23">11 PM</button>
          <button class="bedtime-btn" data-hour="0">12 AM</button>
          <button class="bedtime-btn" data-hour="1">1 AM</button>
          <button class="bedtime-btn" data-hour="2">2 AM</button>
        </div>
      </div>
      
     <div class="drink-selector">
  <h2 class="section-title">What did you drink?</h2>
  <div class="drinks">
    <!-- 1) Brewed coffee -->
    <button class="drink" data-caffeine="144" data-name="Coffee (12 oz brewed)">
      <div class="drink-name">Coffee</div>
      <div class="drink-caffeine">12 oz, 144 mg</div>
    </button>

    <!-- 2) Espresso shot for lattes/capps -->
    <button class="drink" data-caffeine="64" data-name="Espresso (1 oz)">
      <div class="drink-name">Espresso</div>
      <div class="drink-caffeine">1 oz, 64 mg</div>
    </button>

    <!-- 3) Black tea -->
    <button class="drink" data-caffeine="48" data-name="Black Tea (8 oz)">
      <div class="drink-name">Black Tea</div>
      <div class="drink-caffeine">8 oz, 48 mg</div>
    </button>

    <!-- 4) Green tea -->
    <button class="drink" data-caffeine="28" data-name="Green Tea (8 oz)">
      <div class="drink-name">Green Tea</div>
      <div class="drink-caffeine">8 oz, 28 mg</div>
    </button>

    <!-- 5) Cola -->
    <button class="drink" data-caffeine="34" data-name="Cola (12 oz)">
      <div class="drink-name">Cola</div>
      <div class="drink-caffeine">12 oz, 34 mg</div>
    </button>

    <!-- 6) Energy drink -->
    <button class="drink" data-caffeine="160" data-name="Energy Drink (16 oz)">
      <div class="drink-name">Energy Drink</div>
      <div class="drink-caffeine">16 oz, 160 mg</div>
    </button>
  </div>
</div>

      
      <div class="amount-selector">
        <h2 class="section-title">How many?</h2>
        <div class="amount-controls">
          <button class="amount-btn" id="decreaseBtn">−</button>
          <div class="amount-display" id="amountDisplay">1</div>
          <button class="amount-btn" id="increaseBtn">+</button>
        </div>
      </div>
      
      <div class="time-selector">
        <h2 class="section-title">When?</h2>
        <div class="time-options">
          <button class="time-option selected" id="nowBtn">Now</button>
          <button class="time-option" id="customBtn">Choose Time</button>
        </div>
        <div class="time-picker" id="timePicker">
        </div>
      </div>
      
      <div class="total-dose" id="totalDose">
        <div class="dose-amount" id="doseAmount">95mg</div>
        <div class="dose-label">Total caffeine dose</div>
      </div>
      
      <button class="cta-button" id="addButton" disabled>
        Add Drink
      </button>
    </div>
    
    <div class="results" id="results">
      <div class="bedtime-result">
        <div class="bedtime-time" id="bedtimeDisplay">At 10 PM</div>
        <div class="caffeine-at-bedtime" id="caffeineAtBedtime">0mg</div>
        <div class="caffeine-status" id="caffeineStatus">Perfect for sleep</div>
        <div class="caffeine-note" id="caffeineNote">No active caffeine in your system</div>
      </div>
      
      <div class="drinks-log">
        <h3 class="section-title">Today's Drinks</h3>
        <div id="drinksList">
        </div>
      </div>
      
      <ul class="timeline" id="timeline">
      </ul>
      
      <button class="reset-button" id="resetButton">
        Clear All Drinks
      </button>
    </div>
    
    <div id="emptyState" class="empty-state">
      <div class="empty-icon">🧋</div>
      <div class="empty-text">Add your first drink to get started</div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Core constants
    const CAFFEINE_HALF_LIFE = 5; // hours
    
    // State
    let caffeineLog = [];
    let selectedDrink = null;
    let amount = 1;
    let bedtimeHour = 22; // 10 PM default
    let selectedTime = new Date();
    let useCurrentTime = true;
    
    // DOM elements
    const bedtimeBtns = document.querySelectorAll('.bedtime-btn');
    const drinks = document.querySelectorAll('.drink');
    const decreaseBtn = document.getElementById('decreaseBtn');
    const increaseBtn = document.getElementById('increaseBtn');
    const amountDisplay = document.getElementById('amountDisplay');
    const nowBtn = document.getElementById('nowBtn');
    const customBtn = document.getElementById('customBtn');
    const timePicker = document.getElementById('timePicker');
    const totalDose = document.getElementById('totalDose');
    const doseAmount = document.getElementById('doseAmount');
    const addButton = document.getElementById('addButton');
    const results = document.getElementById('results');
    const bedtimeDisplay = document.getElementById('bedtimeDisplay');
    const caffeineAtBedtime = document.getElementById('caffeineAtBedtime');
    const caffeineStatus = document.getElementById('caffeineStatus');
    const caffeineNote = document.getElementById('caffeineNote');
    const drinksList = document.getElementById('drinksList');
    const timeline = document.getElementById('timeline');
    const resetButton = document.getElementById('resetButton');
    const emptyState = document.getElementById('emptyState');
    
    // Haptic feedback
    function hapticFeedback() {
        if (navigator.vibrate) {
            navigator.vibrate(10);
        }
    }
    
    // Local storage functions
    function saveCaffeineLog() {
        localStorage.setItem('caffeineLog', JSON.stringify(caffeineLog));
        localStorage.setItem('caffeineLogDate', new Date().toDateString());
    }

    function loadCaffeineLog() {
        const savedDate = localStorage.getItem('caffeineLogDate');
        const today = new Date().toDateString();
        
        // Only load if it's from today, otherwise start fresh
        if (savedDate === today) {
            const savedLog = localStorage.getItem('caffeineLog');
            if (savedLog) {
                caffeineLog = JSON.parse(savedLog).map(entry => ({
                    ...entry,
                    time: new Date(entry.time) // Convert back to Date object
                }));
            }
        } else {
            // Clear old data if it's a new day
            localStorage.removeItem('caffeineLog');
            localStorage.removeItem('caffeineLogDate');
            caffeineLog = [];
        }
    }
    
    // Smart defaults
    function loadSmartDefaults() {
        const savedBedtime = localStorage.getItem('preferredBedtime');
        if (savedBedtime) {
            bedtimeHour = parseInt(savedBedtime);
            bedtimeBtns.forEach(btn => {
                btn.classList.remove('selected');
                if (parseInt(btn.dataset.hour) === bedtimeHour) {
                    btn.classList.add('selected');
                }
            });
        }
    }
    
    function saveSmartDefaults() {
        localStorage.setItem('preferredBedtime', bedtimeHour);
        
        // Save drink usage stats
        const drinkStats = JSON.parse(localStorage.getItem('drinkStats') || '{}');
        if (selectedDrink) {
            drinkStats[selectedDrink.name] = (drinkStats[selectedDrink.name] || 0) + 1;
            localStorage.setItem('drinkStats', JSON.stringify(drinkStats));
        }
    }
    
    function getMostUsedDrink() {
        const drinkStats = JSON.parse(localStorage.getItem('drinkStats') || '{}');
        let mostUsed = null;
        let maxCount = 0;
        
        for (const [drinkName, count] of Object.entries(drinkStats)) {
            if (count > maxCount) {
                maxCount = count;
                mostUsed = drinkName;
            }
        }
        return mostUsed;
    }
    
    
    // Core calculation
    function calculateCaffeineAtTime(targetTime) {
        let total = 0;
        caffeineLog.forEach(entry => {
            const hoursElapsed = (targetTime - entry.time) / (1000 * 60 * 60);
            if (hoursElapsed >= 0) {
                total += entry.amount * Math.pow(0.5, hoursElapsed / CAFFEINE_HALF_LIFE);
            }
        });
        return total;
    }
    
    // Get bedtime for today/tomorrow
    function getBedtime() {
        const now = new Date();
        const bedtime = new Date();
        bedtime.setHours(bedtimeHour, 0, 0, 0);
        
        // If bedtime has passed today, use tomorrow
        if (bedtime.getTime() <= now.getTime()) {
            bedtime.setDate(bedtime.getDate() + 1);
        }
        
        return bedtime;
    }
    
    // Format time display
    function formatTime(date) {
        const hours = date.getHours();
        let displayHour = hours;
        let ampm = 'AM';
        
        if (hours >= 12) {
            ampm = 'PM';
            if (hours > 12) displayHour = hours - 12;
        }
        if (hours === 0) displayHour = 12;
        
        return `${displayHour} ${ampm}`;
    }
    
    // Generate time picker options
    function generateTimePicker() {
        timePicker.innerHTML = '';
        const now = new Date();
        
        // Generate times from 5 AM today to current time + 8 hours
        for (let i = 5; i <= 23; i++) {
            const time = new Date();
            time.setHours(i, 0, 0, 0);
            
            // Skip future times beyond reasonable planning horizon
            if (time.getTime() > now.getTime() + 8 * 60 * 60 * 1000) continue;
            
            const btn = document.createElement('button');
            btn.className = 'time-btn';
            btn.textContent = formatTime(time);
            btn.dataset.hour = i;
            
            btn.addEventListener('click', () => {
                document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedTime = new Date();
                selectedTime.setHours(parseInt(btn.dataset.hour), 0, 0, 0);
                hapticFeedback();
                updateState();
            });
            
            timePicker.appendChild(btn);
        }
    }
    
    // Get caffeine level description
    function getCaffeineDescription(amount) {
        if (amount < 5) {
            return {
                status: 'Perfect for sleep',
                note: 'No active caffeine in your system',
                class: 'low'
            };
        } else if (amount < 25) {
            return {
                status: 'Minimal impact',
                note: 'Very low caffeine levels remaining',
                class: 'low'
            };
        } else if (amount < 50) {
            return {
                status: 'May affect sleep quality',
                note: 'Moderate caffeine levels remaining',
                class: 'medium'
            };
        } else {
            return {
                status: 'Will likely disrupt sleep',
                note: 'High caffeine levels remaining',
                class: 'high'
            };
        }
    }
    
    // Update drinks log display
    function updateDrinksList() {
        drinksList.innerHTML = '';
        
        // Sort drinks by time
        const sortedDrinks = [...caffeineLog].sort((a, b) => a.time - b.time);
        
        sortedDrinks.forEach((drink, index) => {
            const entry = document.createElement('div');
            entry.className = 'drink-entry';
            
            const now = new Date();
            const isToday = drink.time.toDateString() === now.toDateString();
            const timeDisplay = isToday ? formatTime(drink.time) : 'Yesterday ' + formatTime(drink.time);
            
            entry.innerHTML = `
                <div class="drink-info">
                    <div class="drink-entry-name">${drink.name}</div>
                    <div class="drink-entry-details">${drink.amount}mg at ${timeDisplay}</div>
                </div>
                <button class="delete-btn" data-index="${index}">×</button>
            `;
            
            drinksList.appendChild(entry);
        });
        
        // Add delete event listeners
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const index = parseInt(btn.dataset.index);
                caffeineLog.splice(index, 1);
                saveCaffeineLog();
                hapticFeedback();
                updateState();
                showSmartTip();
            });
        });
    }
    
    // Update UI state
    function updateState() {
        // Update amount controls
        decreaseBtn.disabled = amount <= 1;
        increaseBtn.disabled = amount >= 10;
        amountDisplay.textContent = amount;
        
        // Update bedtime display
        const bedtime = getBedtime();
        const isToday = bedtime.toDateString() === new Date().toDateString();
        bedtimeDisplay.textContent = `${isToday ? 'Today' : 'Tomorrow'} at ${formatTime(bedtime)}`;
        
        // Update total dose display
        if (selectedDrink) {
            const total = selectedDrink.amount * amount;
            doseAmount.textContent = `${total}mg`;
            totalDose.classList.add('show');
            addButton.disabled = false;
        } else {
            totalDose.classList.remove('show');
            addButton.disabled = true;
        }
        
        // Show/hide empty state and results
        if (caffeineLog.length > 0) {
            updateResults();
            updateDrinksList();
            results.classList.add('show');
            emptyState.style.display = 'none';
        } else {
            results.classList.remove('show');
            emptyState.style.display = 'block';
        }
    }
    
    // Update main results display
    function updateResults() {
        const bedtime = getBedtime();
        const caffeineAmount = calculateCaffeineAtTime(bedtime);
        const description = getCaffeineDescription(caffeineAmount);
        
        // Update main bedtime result
        caffeineAtBedtime.textContent = `${Math.round(caffeineAmount)}mg`;
        caffeineAtBedtime.className = `caffeine-at-bedtime ${description.class}`;
        caffeineStatus.textContent = description.status;
        caffeineNote.textContent = description.note;
        
        // Update timeline
        updateTimeline();
    }
    
    // Generate timeline visualization
    function updateTimeline() {
        timeline.innerHTML = '';
        const currentTime = new Date();
        const maxCaffeine = Math.max(100, calculateCaffeineAtTime(currentTime));
        
        for (let i = 0; i <= 12; i++) {
            const time = new Date(currentTime.getTime() + i * 60 * 60 * 1000);
            const caffeine = calculateCaffeineAtTime(time);
            
            if (caffeine < 1 && i > 2) break;
            
            const item = document.createElement('li');
            item.className = 'timeline-item';
            item.style.animationDelay = `${i * 0.1}s`;
            
            const percentage = Math.max(5, (caffeine / maxCaffeine) * 100);
            let fillClass = 'fill-clear';
            
            if (caffeine > 50) fillClass = 'fill-high';
            else if (caffeine > 25) fillClass = 'fill-medium';
            else if (caffeine > 5) fillClass = 'fill-low';
            
            item.innerHTML = `
                <div class="timeline-time">${formatTime(time)}</div>
                <div class="timeline-bar">
                    <div class="timeline-fill ${fillClass}" style="width: ${percentage}%"></div>
                </div>
                <div class="timeline-amount">${Math.round(caffeine)}mg</div>
            `;
            
            timeline.appendChild(item);
        }
    }
    
    // Event listeners
    bedtimeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            bedtimeBtns.forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            bedtimeHour = parseInt(btn.dataset.hour);
            hapticFeedback();
            saveSmartDefaults();
            updateState();
        });
    });
    
    drinks.forEach(drink => {
        drink.addEventListener('click', () => {
            drinks.forEach(d => d.classList.remove('selected'));
            drink.classList.add('selected');
            selectedDrink = {
                name: drink.dataset.name,
                amount: parseInt(drink.dataset.caffeine)
            };
            hapticFeedback();
            updateState();
        });
    });
    
    decreaseBtn.addEventListener('click', () => {
        if (amount > 1) {
            amount--;
            hapticFeedback();
            updateState();
        }
    });
    
    increaseBtn.addEventListener('click', () => {
        if (amount < 10) {
            amount++;
            hapticFeedback();
            updateState();
        }
    });
    
    nowBtn.addEventListener('click', () => {
        useCurrentTime = true;
        nowBtn.classList.add('selected');
        customBtn.classList.remove('selected');
        timePicker.classList.remove('show');
        selectedTime = new Date();
        hapticFeedback();
        updateState();
    });
    
    customBtn.addEventListener('click', () => {
        useCurrentTime = false;
        customBtn.classList.add('selected');
        nowBtn.classList.remove('selected');
        timePicker.classList.add('show');
        generateTimePicker();
        hapticFeedback();
        updateState();
    });
    
    addButton.addEventListener('click', () => {
        if (selectedDrink) {
            const drinkTime = useCurrentTime ? new Date() : new Date(selectedTime);
            
            caffeineLog.push({
                ...selectedDrink,
                amount: selectedDrink.amount * amount,
                time: drinkTime
            });
            
            saveCaffeineLog();
            saveSmartDefaults();
            hapticFeedback();
            
            // Reset selection
            drinks.forEach(d => d.classList.remove('selected'));
            selectedDrink = null;
            amount = 1;
            
            // Reset to "Now" option
            nowBtn.click();
            
            updateState();
            showSmartTip();
        }
    });
    
    resetButton.addEventListener('click', () => {
        caffeineLog = [];
        localStorage.removeItem('caffeineLog');
        localStorage.removeItem('caffeineLogDate');
        drinks.forEach(d => d.classList.remove('selected'));
        selectedDrink = null;
        amount = 1;
        hapticFeedback();
        nowBtn.click();
        updateState();
        showSmartTip();
    });
    
    // Initialize
    loadCaffeineLog();
    loadSmartDefaults();
    updateState();
    showSmartTip();
});
</script>
</body>
</html>