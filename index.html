<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>When Will You Sleep?</title>
<meta name="description" content="See exactly when caffeine will clear your system. Time your coffee to protect your sleep." />
<style>
  :root{
    --bg: #000000;
    --panel: #1C1C1E;
    --text: #FFFFFF;
    --text-secondary: #8E8E93;
    --accent: #007AFF;
    --success: #30D158;
    --warning: #FF9500;
    --danger: #FF3B30;
    --radius: 16px;
    --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    --max-width: 500px;
  }
  
  * { 
    box-sizing: border-box; 
    margin: 0; 
    padding: 0; 
  }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.4;
    -webkit-font-smoothing: antialiased;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  
  .container {
    max-width: var(--max-width);
    width: 100%;
  }
  
  .app {
    background: var(--panel);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  
  .header {
    text-align: center;
    padding: 40px 32px 32px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .title {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 8px;
    letter-spacing: -0.5px;
  }
  
  .subtitle {
    color: var(--text-secondary);
    font-size: 17px;
    font-weight: 400;
  }
  
  .input-section {
    padding: 32px;
  }
  
  .input-group {
    margin-bottom: 32px;
  }
  
  .label {
    display: block;
    font-size: 17px;
    font-weight: 600;
    margin-bottom: 12px;
  }
  
  .drink-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 24px;
  }
  
  .drink-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 16px 12px;
    color: var(--text);
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 15px;
    font-weight: 500;
  }
  
  .drink-btn:hover {
    border-color: var(--accent);
    background: rgba(0, 122, 255, 0.1);
  }
  
  .drink-btn.selected {
    border-color: var(--accent);
    background: var(--accent);
    color: white;
  }
  
  .drink-name {
    font-weight: 600;
    margin-bottom: 4px;
  }
  
  .drink-caffeine {
    font-size: 13px;
    opacity: 0.8;
  }
  
  .time-section {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 20px;
  }
  
  .now-btn, .time-btn {
    flex: 1;
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 16px 20px;
    color: var(--text);
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
  }
  
  .now-btn:hover, .time-btn:hover {
    border-color: var(--accent);
    background: rgba(0, 122, 255, 0.1);
  }
  
  .now-btn.selected, .time-btn.selected {
    border-color: var(--accent);
    background: var(--accent);
    color: white;
  }
  
  .time-picker {
    width: 100%;
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 24px;
    margin-top: 12px;
  }
  
  .time-picker.hidden {
    display: none;
  }
  
  .time-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
  }
  
  .time-option {
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 12px 8px;
    color: var(--text);
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
    font-weight: 500;
  }
  
  .time-option:hover {
    border-color: var(--accent);
    background: rgba(0, 122, 255, 0.1);
  }
  
  .time-option.selected {
    border-color: var(--accent);
    background: var(--accent);
    color: white;
  }
  
  .servings-section {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 16px;
  }
  
  .servings-label {
    font-size: 17px;
    font-weight: 600;
  }
  
  .servings-controls {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  
  .serving-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.2);
    color: var(--text);
    font-size: 20px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .serving-btn:hover {
    border-color: var(--accent);
    background: rgba(0, 122, 255, 0.1);
  }
  
  .serving-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }
  
  .serving-count {
    font-size: 24px;
    font-weight: 700;
    min-width: 40px;
    text-align: center;
  }
  
  .dose-summary {
    background: rgba(0, 122, 255, 0.1);
    border: 1px solid rgba(0, 122, 255, 0.3);
    border-radius: 12px;
    padding: 16px;
    margin-top: 20px;
    text-align: center;
    display: none;
  }
  
  .dose-summary.show {
    display: block;
    animation: slideUp 0.3s ease-out;
  }
  
  .total-caffeine {
    font-size: 20px;
    font-weight: 700;
    color: var(--accent);
    margin-bottom: 4px;
  }
  
  .dose-note {
    font-size: 14px;
    color: var(--text-secondary);
  }
  
  .calculate-btn {
    width: 100%;
    background: var(--success);
    border: none;
    border-radius: 12px;
    padding: 20px;
    color: white;
    font-size: 19px;
    font-weight: 700;
    cursor: pointer;
    margin-top: 32px;
    transition: all 0.2s ease;
    letter-spacing: -0.2px;
  }
  
  .calculate-btn:hover {
    background: #28B946;
    transform: translateY(-1px);
  }
  
  .calculate-btn:disabled {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-secondary);
    cursor: not-allowed;
    transform: none;
  }
  
  .results {
    background: rgba(255, 255, 255, 0.03);
    padding: 32px;
    display: none;
  }
  
  .results.show {
    display: block;
    animation: slideUp 0.3s ease-out;
  }
  
  @keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .timeline {
    list-style: none;
  }
  
  .timeline-item {
    display: grid;
    grid-template-columns: 1fr 80px 80px; /* Use grid for aligned columns */
    align-items: center;
    padding: 16px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  }
  
  .timeline-item:last-child {
    border-bottom: none;
  }
  
  .timeline-time {
    font-size: 17px;
    font-weight: 600;
    text-align: right;
    transition: color 0.2s ease;
  }
  
  .timeline-time.tomorrow {
    color: var(--text-secondary);
  }
  
  .timeline-amount {
    font-size: 15px;
    color: var(--text-secondary);
    min-width: 80px;
    text-align: right;
    padding-right: 12px;
  }

  .timeline-status {
    font-size: 13px;
    padding: 4px 8px;
    border-radius: 6px;
    font-weight: 600;
    text-align: left;
  }
  
  .status-extreme {
    background: var(--danger);
    color: white;
  }
  
  .status-high {
    background: var(--warning);
    color: black;
  }
  
  .status-medium {
    background: rgba(255, 149, 0, 0.3);
    color: var(--warning);
  }
  
  .status-low {
    background: rgba(48, 209, 88, 0.3);
    color: var(--success);
  }
  
  .status-clear {
    background: rgba(48, 209, 88, 0.2);
    color: var(--success);
  }
  
  .sleep-recommendation {
    background: rgba(48, 209, 88, 0.1);
    border: 1px solid rgba(48, 209, 88, 0.3);
    border-radius: 12px;
    padding: 20px;
    margin-top: 24px;
    text-align: center;
  }
  
  .sleep-time {
    font-size: 24px;
    font-weight: 700;
    color: var(--success);
  }
  
  .sleep-note {
    font-size: 15px;
    color: var(--text-secondary);
    margin-top: 8px;
  }
  
  .reset-btn {
    width: 100%;
    background: var(--accent);
    border: none;
    border-radius: 12px;
    padding: 16px;
    color: white;
    font-size: 17px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 24px;
    transition: opacity 0.2s ease;
  }
  
  .reset-btn:hover {
    opacity: 0.8;
  }
  
  .footer {
    text-align: center;
    padding: 24px;
    color: var(--text-secondary);
    font-size: 13px;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
  }
  
  @media (max-width: 480px) {
    .drink-grid {
      grid-template-columns: 1fr;
    }
    
    .timeline-item {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }
    
    .timeline-amount {
      text-align: left;
    }
    
    .time-section {
      flex-direction: column;
      gap: 16px;
    }
    
    .now-btn, .time-btn {
      width: 100%;
    }
    
    .time-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }
  
  .info-section {
    background: rgba(255, 255, 255, 0.02);
    padding: 40px 32px;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
  }
  
  .info-content {
    max-width: 600px;
    margin: 0 auto;
    line-height: 1.6;
  }
  
  .info-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .info-subtitle {
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
    margin-top: 32px;
    margin-bottom: 16px;
  }
  
  .info-text {
    color: var(--text-secondary);
    margin-bottom: 16px;
    font-size: 15px;
  }
  
  .disclaimer {
    background: rgba(255, 149, 0, 0.1);
    border: 1px solid rgba(255, 149, 0, 0.3);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
  }
  
  .disclaimer-text {
    color: var(--warning);
    font-weight: 600;
    font-size: 15px;
    text-align: center;
  }
  
  .formula {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 16px;
    margin: 16px 0;
    font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
    font-size: 14px;
    text-align: center;
    color: var(--accent);
    border: 1px solid rgba(0, 122, 255, 0.2);
  }
  
  .factor-list {
    list-style: none;
    margin: 16px 0;
  }
  
  .factor-list li::before {
    content: "•";
    color: var(--accent);
    font-weight: bold;
    position: absolute;
    left: 0;
  }
  
  .factor-name {
    font-weight: 600;
    color: var(--text);
  }
  
  .sleep-ready-highlight {
    background: rgba(48, 209, 88, 0.1);
    color: var(--success);
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 600;
  }
  
  .half-life-highlight {
    background: rgba(0, 122, 255, 0.1);
    color: var(--accent);
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 600;
  }
  
  @media (max-width: 480px) {
    .info-section {
      padding: 32px 20px;
    }
    
    .info-title {
      font-size: 18px;
    }
    
    .info-subtitle {
      font-size: 16px;
      margin-top: 24px;
    }
    
    .formula {
      font-size: 12px;
      padding: 12px;
    }
    
    .timeline-item {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }
    
    .timeline-amount {
      text-align: left;
    }
  }
</style>
</head>
<body>
  <div class="container">
    <div class="app">
      <div class="header">
        <h1 class="title">When Sleep?</h1>
        <p class="subtitle">See exactly when caffeine clears your system</p>
      </div>
      
      <div class="input-section">
        <div class="input-group">
          <label class="label">What did you drink?</label>
          <div class="drink-grid">
            <button class="drink-btn" data-caffeine="95" data-name="Coffee">
              <div class="drink-name">Coffee</div>
              <div class="drink-caffeine">95mg</div>
            </button>
            <button class="drink-btn" data-caffeine="63" data-name="Espresso">
              <div class="drink-name">Espresso</div>
              <div class="drink-caffeine">63mg</div>
            </button>
            <button class="drink-btn" data-caffeine="80" data-name="Energy Drink">
              <div class="drink-name">Energy Drink</div>
              <div class="drink-caffeine">80mg</div>
            </button>
            <button class="drink-btn" data-caffeine="47" data-name="Black Tea">
              <div class="drink-name">Black Tea</div>
              <div class="drink-caffeine">47mg</div>
            </button>
          </div>
          
          <div class="servings-section">
            <span class="servings-label">How many?</span>
            <div class="servings-controls">
              <button class="serving-btn" id="decreaseBtn">−</button>
              <span class="serving-count" id="servingCount">1</span>
              <button class="serving-btn" id="increaseBtn">+</button>
            </div>
          </div>
          
          <div class="dose-summary" id="doseSummary">
            <div class="total-caffeine" id="totalCaffeine">95mg total</div>
            <div class="dose-note">Moderate dose</div>
          </div>
        </div>
        
        <div class="input-group">
          <label class="label">When?</label>
          <div class="time-section">
            <button class="now-btn selected" id="nowBtn">Right Now</button>
            <button class="time-btn" id="timeBtn">Different Time</button>
          </div>
          <div class="time-picker hidden" id="timePicker">
            <div class="time-grid" id="timeGrid">
              <!-- Time options will be generated -->
            </div>
          </div>
        </div>
        
        <button class="calculate-btn" id="calculateBtn">Add to Log</button>
      </div>
      
      <div class="results" id="results">
        <ul class="timeline" id="timeline">
          <!-- Timeline items will be generated here -->
        </ul>
        
        <div class="sleep-recommendation">
          <div class="sleep-time" id="sleepTime"></div>
          <div class="sleep-note" id="sleepNote">Safe bedtime for good sleep</div>
        </div>
        
        <button class="reset-btn" id="resetBtn">Clear All Drinks</button>
      </div>
      
      <div class="info-section">
        
        <h3 class="info-title">How It Works 🧠</h3>
        <p class="info-text">
          This app uses a widely-accepted model for caffeine clearance based on a half-life of 5 hours. This means that for every 5 hours that pass, the caffeine in your system is halved. The app's timeline shows how the caffeine from each drink you add cumulatively affects your total level over time, helping you visualize when you will be "Sleep Ready" (<5mg).
        </p>
        <p class="info-text">
          Keep in mind that individual metabolism can vary significantly due to factors like genetics, age, and liver health. This tool provides a useful estimate, but your personal experience may differ.
        </p>
      </div>
      
      <div class="footer">
        Based on 5-hour caffeine half-life. This is not medical advice and should not be relied upon for actual sleep management.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Core Logic ---
    const CAFFEINE_HALF_LIFE = 5; // hours
    const SLEEP_READY_THRESHOLD = 5; // mg
    let BEDTIME_HOUR = 22; // 10 PM default

    let caffeineLog = [];

    // --- DOM Elements ---
    const nowBtn = document.getElementById('nowBtn');
    const timeBtn = document.getElementById('timeBtn');
    const timePicker = document.getElementById('timePicker');
    const timeGrid = document.getElementById('timeGrid');
    const drinkButtons = document.querySelectorAll('.drink-btn');
    const decreaseBtn = document.getElementById('decreaseBtn');
    const increaseBtn = document.getElementById('increaseBtn');
    const servingCountEl = document.getElementById('servingCount');
    const doseSummaryEl = document.getElementById('doseSummary');
    const totalCaffeineEl = document.getElementById('totalCaffeine');
    const doseNoteEl = doseSummaryEl.querySelector('.dose-note');
    const calculateBtn = document.getElementById('calculateBtn');
    const resultsSection = document.getElementById('results');
    const timelineList = document.getElementById('timeline');
    const sleepTimeEl = document.getElementById('sleepTime');
    const sleepNoteEl = document.getElementById('sleepNote');
    const resetBtn = document.getElementById('resetBtn');
    const bedtimePickerContainer = document.createElement('div');
    bedtimePickerContainer.id = 'bedtimePicker';
    bedtimePickerContainer.className = 'input-group';
    bedtimePickerContainer.innerHTML = `
      <label class="label">Desired Bedtime</label>
      <div class="time-grid" id="bedtimeTimeGrid"></div>
    `;
    document.querySelector('.input-section').appendChild(bedtimePickerContainer);
    const bedtimeTimeGrid = document.getElementById('bedtimeTimeGrid');

    // --- State Variables ---
    let selectedDrink = null;
    let selectedTime = null;
    let servings = 1;
    let useCurrentTime = true;
    let selectedBedtimeHour = BEDTIME_HOUR;

    // --- Local Storage Management ---
    function saveLogToLocalStorage() {
      localStorage.setItem('caffeineLog', JSON.stringify(caffeineLog));
    }

    function loadLogFromLocalStorage() {
      const savedLog = localStorage.getItem('caffeineLog');
      if (savedLog) {
        caffeineLog = JSON.parse(savedLog).map(item => ({
          ...item,
          time: new Date(item.time)
        }));
      }
    }

    // --- Calculation Functions ---
    function calculateCaffeineAtTime(targetTime) {
      let totalCaffeine = 0;
      caffeineLog.forEach(entry => {
        const elapsedHours = (targetTime.getTime() - entry.time.getTime()) / (1000 * 60 * 60);
        if (elapsedHours >= 0) {
          totalCaffeine += entry.amount * Math.pow(0.5, elapsedHours / CAFFEINE_HALF_LIFE);
        }
      });
      return totalCaffeine;
    }

    // --- Rendering and UI Update Functions ---
    function getStatusBadge(caffeineAmount) {
      if (caffeineAmount > 100) {
        return { name: 'Wired', class: 'status-extreme' };
      } else if (caffeineAmount > 50) {
        return { name: 'Wide Awake', class: 'status-high' };
      } else if (caffeineAmount > 25) {
        return { name: 'Still Alert', class: 'status-medium' };
      } else if (caffeineAmount > SLEEP_READY_THRESHOLD) {
        return { name: 'Drowsy', class: 'status-low' };
      } else {
        return { name: 'Sleep Ready', class: 'status-clear' };
      }
    }

    function updateTimeline() {
      timelineList.innerHTML = '';
      
      const startTime = new Date();
      startTime.setMinutes(0, 0, 0);
      
      const totalCurrentCaffeine = calculateCaffeineAtTime(new Date());
      let sleepReadyTime;

      // Calculate precise sleep ready time based on total current caffeine
      if (totalCurrentCaffeine <= SLEEP_READY_THRESHOLD) {
          sleepReadyTime = new Date();
      } else {
          const hoursToSleepReady = (Math.log(totalCurrentCaffeine / SLEEP_READY_THRESHOLD) / Math.log(2)) * CAFFEINE_HALF_LIFE;
          sleepReadyTime = new Date(new Date().getTime() + hoursToSleepReady * 60 * 60 * 1000);
      }
      
      // If there are no drinks, don't show the timeline or results section
      if (caffeineLog.length === 0) {
          resultsSection.classList.remove('show');
          return;
      }
      
      let previousStatus = '';
      for (let i = 0; i <= 24; i++) {
        const targetTime = new Date(startTime.getTime() + i * 60 * 60 * 1000);
        const currentCaffeine = calculateCaffeineAtTime(targetTime);
        const status = getStatusBadge(currentCaffeine);
        const isTomorrow = targetTime.getDate() > new Date().getDate();

        // Only add items if the status has changed from the previous hour
        if (status.name !== previousStatus && status.name !== 'Sleep Ready') {
          const item = document.createElement('li');
          item.className = 'timeline-item';
          const timeClass = isTomorrow ? 'tomorrow' : '';
          item.innerHTML = `
            <div class="timeline-status ${status.class}">${status.name}</div>
            <div class="timeline-amount">${Math.round(currentCaffeine)}mg</div>
            <div class="timeline-time ${timeClass}">${formatTime(targetTime)}</div>
          `;
          timelineList.appendChild(item);
          previousStatus = status.name;
        }
      }
      
      // Always show the final Sleep Ready entry
      const finalItem = document.createElement('li');
      finalItem.className = 'timeline-item';
      
      const isTomorrow = sleepReadyTime.getDate() > new Date().getDate();
      const timeClass = isTomorrow ? 'tomorrow' : '';

      finalItem.innerHTML = `
        <div class="timeline-status ${getStatusBadge(0).class}">Sleep Ready</div>
        <div class="timeline-amount"><5mg</div>
        <div class="timeline-time ${timeClass}">${formatTime(sleepReadyTime)}</div>
      `;
      timelineList.appendChild(finalItem);
      
      // --- Final result box logic ---
      const bedtime = new Date();
      bedtime.setHours(selectedBedtimeHour, 0, 0, 0);
      if (bedtime.getTime() < new Date().getTime()) {
        bedtime.setDate(bedtime.getDate() + 1);
      }
      
      const caffeineAtBedtime = calculateCaffeineAtTime(bedtime);
      const bedtimeTime = formatTime(bedtime);
      
      let finalTimeText = '';
      let finalNoteText = '';
      
      if (caffeineAtBedtime > SLEEP_READY_THRESHOLD) {
        finalTimeText = `${Math.round(caffeineAtBedtime)}mg at ${bedtimeTime}`;
        finalNoteText = 'Active caffeine level at your desired bedtime';
        sleepTimeEl.classList.remove('tomorrow');
      } else {
        finalTimeText = `${formatTime(sleepReadyTime)}`;
        if (sleepReadyTime.getDate() > new Date().getDate()) {
           finalTimeText += ' Tomorrow';
           sleepTimeEl.classList.add('tomorrow');
        } else {
           sleepTimeEl.classList.remove('tomorrow');
        }
        finalNoteText = 'Time you will reach a negligible dose';
      }

      sleepTimeEl.textContent = finalTimeText;
      sleepNoteEl.textContent = finalNoteText;
      
      resultsSection.classList.add('show');
      resultsSection.scrollIntoView({ behavior: 'smooth' });
    }
    
    function updateDoseSummary() {
      if (!selectedDrink) return;
      
      const totalCaffeine = selectedDrink.amount * servings;
      totalCaffeineEl.textContent = `${totalCaffeine}mg total`;
      
      let note = '';
      if (totalCaffeine <= 100) {
        note = 'Moderate dose';
      } else if (totalCaffeine <= 200) {
        note = 'High dose';
      } else if (totalCaffeine <= 400) {
        note = 'Very high dose';
      } else {
        note = 'Extreme dose - consider reducing';
      }
      
      doseNoteEl.textContent = note;
      doseSummaryEl.classList.add('show');
      updateAddButtonState();
    }

    function generateTimePicker() {
      timeGrid.innerHTML = '';
      
      for (let i = 0; i < 24; i++) {
          const button = document.createElement('button');
          button.className = 'time-option';
          let displayHour = i;
          let ampm = 'AM';
          
          if (i >= 12) {
            ampm = 'PM';
            if (i > 12) displayHour = i - 12;
          }
          if (i === 0) displayHour = 12;
          
          button.textContent = `${displayHour} ${ampm}`;
          button.dataset.hour = i;
          
          button.addEventListener('click', () => {
              document.querySelectorAll('.time-option').forEach(opt => opt.classList.remove('selected'));
              button.classList.add('selected');
              selectedTime = new Date().setHours(parseInt(button.dataset.hour), 0, 0);
              updateAddButtonState();
          });
          timeGrid.appendChild(button);
      }
    }
    
    function generateBedtimePicker() {
      bedtimeTimeGrid.innerHTML = '';
      
      for (let i = 21; i <= 23; i++) { // 9 PM to 11 PM
        const button = document.createElement('button');
        button.className = 'time-option bedtime-option';
        button.textContent = formatTime(new Date().setHours(i, 0, 0));
        button.dataset.hour = i;
        if (i === BEDTIME_HOUR) {
          button.classList.add('selected');
        }
        button.addEventListener('click', () => {
          document.querySelectorAll('.bedtime-option').forEach(opt => opt.classList.remove('selected'));
          button.classList.add('selected');
          selectedBedtimeHour = parseInt(button.dataset.hour);
          updateTimeline();
        });
        bedtimeTimeGrid.appendChild(button);
      }
    }

    // --- Helper Functions ---
    function formatTime(date) {
      const d = new Date(date);
      const hours = d.getHours();
      let displayHour = hours;
      let ampm = 'AM';
      
      if (hours >= 12) {
        ampm = 'PM';
        if (hours > 12) displayHour = hours - 12;
      }
      if (hours === 0) displayHour = 12;
      
      return `${displayHour} ${ampm}`;
    }

    function updateAddButtonState() {
        calculateBtn.disabled = !(selectedDrink && selectedTime);
    }

    function resetApp() {
        caffeineLog = [];
        localStorage.removeItem('caffeineLog');
        resultsSection.classList.remove('show');
        doseSummaryEl.classList.remove('show');
        drinkButtons.forEach(btn => btn.classList.remove('selected'));
        nowBtn.classList.add('selected');
        timeBtn.classList.remove('selected');
        timePicker.classList.add('hidden');
        selectedDrink = null;
        servings = 1;
        servingCountEl.textContent = '1';
        selectedTime = new Date().setMinutes(0,0,0);
        updateAddButtonState();
        updateTimeline();
    }

    // --- Event Listeners and Initialization ---
    drinkButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        drinkButtons.forEach(dBtn => dBtn.classList.remove('selected'));
        btn.classList.add('selected');
        selectedDrink = {
          name: btn.dataset.name,
          amount: parseInt(btn.dataset.caffeine)
        };
        updateDoseSummary();
      });
    });

    decreaseBtn.addEventListener('click', () => {
      if (servings > 1) {
        servings--;
        servingCountEl.textContent = servings;
        updateDoseSummary();
      }
    });

    increaseBtn.addEventListener('click', () => {
      if (servings < 10) {
        servings++;
        servingCountEl.textContent = servings;
        updateDoseSummary();
      }
    });

    nowBtn.addEventListener('click', () => {
        useCurrentTime = true;
        nowBtn.classList.add('selected');
        timeBtn.classList.remove('selected');
        timePicker.classList.add('hidden');
        selectedTime = new Date();
        selectedTime.setMinutes(0, 0, 0);
        updateAddButtonState();
    });

    timeBtn.addEventListener('click', () => {
        useCurrentTime = false;
        timeBtn.classList.add('selected');
        nowBtn.classList.remove('selected');
        timePicker.classList.remove('hidden');
        generateTimePicker();
        updateAddButtonState();
    });

    calculateBtn.addEventListener('click', () => {
      if (selectedDrink && selectedTime) {
        const newEntry = {
          ...selectedDrink,
          amount: selectedDrink.amount * servings,
          time: new Date(selectedTime)
        };
        caffeineLog.push(newEntry);
        caffeineLog.sort((a, b) => a.time - b.time);
        saveLogToLocalStorage();
        updateTimeline();
        
        // Clear selections and reset servings
        drinkButtons.forEach(dBtn => dBtn.classList.remove('selected'));
        document.querySelectorAll('.time-option').forEach(tBtn => tBtn.classList.remove('selected'));
        doseSummaryEl.classList.remove('show');
        selectedDrink = null;
        servings = 1;
        servingCountEl.textContent = '1';
        nowBtn.click();
      }
    });

    resetBtn.addEventListener('click', resetApp);

    // Initial setup
    loadLogFromLocalStorage();
    generateBedtimePicker();
    updateTimeline();
    nowBtn.click();
});
</script>
</body>
</html>
